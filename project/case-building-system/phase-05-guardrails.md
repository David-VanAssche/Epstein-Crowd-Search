# Phase 5: Guardrails, Ethics & Access Controls

**Status:** Not started
**Prerequisites:** Phase 4 (case assembly)
**Blocks:** Production deployment

## Why This Phase Exists

This system will be used by researchers, journalists, and potentially prosecutors. Auto-generated case files that accuse named individuals based on statistical patterns can cause real harm if misused. This phase ensures the system makes researchers **more careful**, not less.

## Checklist

### 5.1 Tiered Access Controls
- [ ] Define access tiers for case-building features:
  | Feature | Public | Contributor | Researcher | Moderator | Admin |
  |---------|--------|-------------|------------|-----------|-------|
  | Embedding map (viz) | View | View | View | View | View |
  | Topic sidebar | View | View | View | View | View |
  | Entity fingerprints | -- | Summary | Full | Full | Full |
  | Pattern matches | -- | -- | View | View+Edit | Full |
  | Case generation | -- | -- | Generate | Generate+Review | Full |
  | PDF export | -- | -- | -- | Approved only | Full |
  | Hypothesis CRUD | -- | -- | Create | Create+Edit | Full |
  | Lead generation | -- | -- | View | View | Full |
- [ ] Implement via `requireTier()` middleware (already exists)
- [ ] Verify: unauthenticated users cannot access case generation

### 5.2 Provenance Tagging UI
- [ ] Visual badges for provenance types:
  - `[DOCUMENTARY]` — green badge, with clickable citation link
  - `[INFERRED]` — yellow badge, with explanation tooltip
  - `[STATISTICAL]` — blue badge, with confidence interval
  - `[CONTEXTUAL]` — gray badge, with "added for narrative coherence" note
- [ ] Hovering any sentence shows its full provenance chain
- [ ] Verify: no sentence in a case narrative lacks a provenance tag

### 5.3 Adversarial Framing (Prosecution + Defense)
- [ ] Case view always shows BOTH perspectives side-by-side
- [ ] Defense view is NOT hidden behind a toggle — it's equally prominent
- [ ] UI design: two-column layout or tabbed view with equal visual weight
- [ ] Verify: defense view addresses each prosecution claim

### 5.4 PDF Export Guardrails
- [ ] Header on every exported PDF:
  ```
  AI-ASSISTED ANALYSIS — NOT A LEGAL DOCUMENT
  Generated by automated pattern detection. Requires independent verification.
  All claims are tagged with provenance level. Statistical patterns are not evidence.
  Generated: [date] | Data version: [snapshot_version] | Reviewed by: [reviewer]
  ```
- [ ] Watermark on every page: "PRELIMINARY — REQUIRES VERIFICATION"
- [ ] Include full methodology section: what algorithms were used, what thresholds, what data version
- [ ] Include calibration data: hypothesis false positive rate
- [ ] Export blocked without human review approval
- [ ] Verify: exported PDF contains all required disclaimers

### 5.5 Base Rate Calibration Display
- [ ] For every pattern match, show calibration:
  ```
  This entity matches the "Trafficking Indicators" hypothesis.
  Calibration: Of 847 entities that matched this hypothesis,
  23 were confirmed relevant by researchers, 412 were confirmed
  irrelevant, and 412 have not been reviewed.
  False positive rate: 94.7% (412 / 435 reviewed)
  ```
- [ ] If false positive rate > 80%, display prominent warning
- [ ] Researchers can update calibration by reviewing matches
- [ ] Verify: calibration stats are accurate and update in real-time

### 5.6 Exculpatory Signal Detection
- [ ] Actively search for evidence that an entity is NOT involved:
  - Entity appears as law enforcement, legal, or journalist in document context
  - Entity is mentioned in exculpatory testimony
  - Entity has documented alibi (different location on same date)
  - Entity's presence is explained by their professional role
- [ ] Exculpatory signals displayed with EQUAL prominence to incriminating signals
- [ ] Verify: known lawyers have prominent exculpatory context in their profiles

### 5.7 Audit Trail
- [ ] Log every case generation:
  - Who requested it, when, for which entity
  - What data version / snapshot was used
  - What hypotheses were active
  - What results were returned
- [ ] Log every PDF export:
  - Who exported, when, for which entity
  - Who approved the review
  - Full snapshot of the case data at export time
- [ ] Retain logs indefinitely (append-only, no delete)
- [ ] Create `case_audit_log` table
- [ ] Verify: audit trail is complete for all case operations

### 5.8 Anti-Weaponization Measures
- [ ] Rate limiting: max 10 case generations per user per hour
- [ ] Entity lookup rate limiting: max 50 entity searches per user per hour
- [ ] No bulk export of case files
- [ ] PDF watermarking includes user ID (traceable if leaked)
- [ ] Monitor for patterns: user generating cases for many unrelated entities (possible harassment campaign)
- [ ] Verify: rate limits enforced, watermarks include user ID

### 5.9 Right of Response Mechanism
- [ ] If the platform names individuals in any public-facing context:
  - Provide a contact form for named individuals to add context
  - Responses stored alongside the entity profile
  - Flagged for moderator review
- [ ] This improves data quality AND demonstrates good faith
- [ ] Verify: contact form works, responses are stored and visible

### 5.10 Cluster Versioning & Stability
- [ ] Topic snapshot versioning (from Phase 1) enforced throughout:
  - All downstream references use versioned topic IDs
  - When clusters are recomputed, run Hungarian algorithm to align new → old topics
  - Publish changelog: which topics split, merged, or disappeared
- [ ] Entity fingerprints, pattern matches, and risk scores recomputed on new snapshot
- [ ] Old snapshot data retained (never deleted)
- [ ] Verify: switching snapshots shows consistent topic references

## Files to Create/Modify

| File | Action |
|------|--------|
| `supabase/migrations/00035_case_guardrails.sql` | Audit log, access controls |
| `components/case/ProvenanceTag.tsx` | Provenance badge component |
| `components/case/DualNarrative.tsx` | Side-by-side prosecution/defense |
| `components/case/CalibrationDisplay.tsx` | False positive rate display |
| `components/case/ExportDisclaimer.tsx` | PDF header/watermark |
| `lib/services/pdf-exporter.ts` | PDF generation with guardrails |
| `lib/services/audit-logger.ts` | Case audit trail |
| `app/api/entity/[id]/case/export/route.ts` | Guarded PDF export |
| `app/api/entity/[id]/response/route.ts` | Right of response |

## Agent Workflow

```
1. PLAN:    Launch Plan agent to design access control matrix
            Launch security-reviewer to audit RLS policies
2. BUILD:   Implement guardrails, audit trail, PDF export
3. REVIEW:  Launch security-reviewer for full security audit
            Launch pre-deploy-reviewer for comprehensive review
4. TEST:    Attempt to bypass guardrails (red team exercise)
5. VERIFY:  Generate a case for a known innocent entity —
            system should produce prominent exculpatory context
```

## Definition of Done

- [ ] Tiered access controls enforced on all case-building features
- [ ] Every narrative sentence has a provenance tag
- [ ] Prosecution and defense views always shown together
- [ ] PDF export includes all required disclaimers + watermark
- [ ] Calibration display shows false positive rates
- [ ] Exculpatory signals detected and displayed prominently
- [ ] Audit trail logs all case operations
- [ ] Rate limiting prevents bulk generation
- [ ] Right of response mechanism available
- [ ] Red team exercise completed: system resists weaponization attempts
